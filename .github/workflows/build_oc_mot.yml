name: OpenClash Auto Release

on:
  push:
    branches: [ dev ]
    paths:
      - 'luci-app-openclash/Makefile'

  workflow_dispatch:
    inputs:
      upload_release:
        description: 'Upload ke GitHub Release?'
        required: true
        default: 'true'
        type: choice
        options:
          - 'false'
          - 'true'

      upload_telegram:
        description: 'Upload IPK/APK ke Telegram?'
        required: true
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

env:
  PKG_NAME: luci-app-openclash
  TARGET: x86/64

jobs:
  get_version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.ver.outputs.version }}
    steps:
      - uses: actions/checkout@v4
      - id: ver
        run: |
          VER=$(grep 'PKG_VERSION:=' luci-app-openclash/Makefile | cut -d= -f2)
          echo "version=$VER" >> "$GITHUB_OUTPUT"

  build:
    runs-on: ubuntu-latest
    needs: get_version
    strategy:
      fail-fast: false
      matrix:
        type: [ ipk, apk ]

    steps:
      - uses: actions/checkout@v4

      - name: Install deps
        run: |
          sudo apt update
          sudo apt install -y curl git tar zstd unzip jq \
            python3 python3-pyelftools python3-setuptools

      - name: Download SDK
        run: |
          mkdir -p sdk && cd sdk
          if [ "${{ matrix.type }}" = "ipk" ]; then
            curl -Lf https://downloads.openwrt.org/releases/22.03.0/targets/x86/64/openwrt-sdk-22.03.0-x86-64_gcc-11.2.0_musl.Linux-x86_64.tar.xz | tar xJ
          else
            curl -Lf https://downloads.openwrt.org/snapshots/targets/x86/64/openwrt-sdk-x86-64_gcc-14.3.0_musl.Linux-x86_64.tar.zst | tar --zstd -xf -
          fi
          mv openwrt-sdk-* openwrt

      - name: Copy source
        run: cp -r luci-app-openclash sdk/openwrt/package/

      - name: Update OpenClash resources
        run: |
          BASE=sdk/openwrt/package/luci-app-openclash/root
          TMP=tmp
          mkdir -p "$TMP"

          curl -sSL https://ispip.clang.cn/all_cn.txt -o "$TMP/china.ipset"
          curl -sSL https://ispip.clang.cn/all_cn_ipv6.txt -o "$TMP/china6.ipset"
          mkdir -p "$BASE/etc/openclash"
          cp "$TMP/china.ipset"  "$BASE/etc/openclash/china_ip_route.ipset"
          cp "$TMP/china6.ipset" "$BASE/etc/openclash/china_ip6_route.ipset"

          curl -sSL https://github.com/MetaCubeX/metacubexd/archive/refs/heads/gh-pages.zip -o "$TMP/metacubexd.zip"
          unzip -q "$TMP/metacubexd.zip" -d "$TMP"
          rm -rf "$BASE/usr/share/openclash/ui/metacubexd"
          mkdir -p "$BASE/usr/share/openclash/ui/metacubexd"
          cp -r "$TMP"/metacubexd-gh-pages/* "$BASE/usr/share/openclash/ui/metacubexd"

          curl -sSL https://github.com/Zephyruso/zashboard/releases/latest/download/dist-cdn-fonts.zip -o "$TMP/zashboard.zip"
          unzip -q "$TMP/zashboard.zip" -d "$TMP/zashboard"
          rm -rf "$BASE/usr/share/openclash/ui/zashboard"
          mkdir -p "$BASE/usr/share/openclash/ui/zashboard"
          cp -r "$TMP/zashboard/dist/"* "$BASE/usr/share/openclash/ui/zashboard"

          TAG=$(curl -s https://api.github.com/repos/Loyalsoldier/v2ray-rules-dat/releases/latest | jq -r .tag_name)
          curl -sSL https://github.com/Loyalsoldier/v2ray-rules-dat/releases/download/$TAG/geosite.dat \
            -o "$BASE/etc/openclash/GeoSite.dat"

          curl -sSL https://github.com/alecthw/mmdb_china_ip_list/releases/latest/download/Country-lite.mmdb \
            -o "$BASE/etc/openclash/Country.mmdb"

      - name: Compile po2lmo
        run: |
          cd sdk/openwrt/package/luci-app-openclash/tools/po2lmo
          make && sudo make install

      - name: Compile package
        run: |
          cd sdk/openwrt
          make defconfig
          make package/${{ env.PKG_NAME }}/compile -j$(nproc)

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: openclash-${{ matrix.type }}
          path: sdk/openwrt/bin/packages/**/${{ env.PKG_NAME }}*

  release:
    runs-on: ubuntu-latest
    needs: [ get_version, build ]

    steps:
      - uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Create GitHub Release
        if: |
          success() && (
            github.event_name == 'push' ||
            (github.event_name == 'workflow_dispatch' && inputs.upload_release == 'true')
          )
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.get_version.outputs.version }}
          name: OpenClash v${{ needs.get_version.outputs.version }}
          files: |
            dist/**/${{ env.PKG_NAME }}_*.ipk
            dist/**/${{ env.PKG_NAME }}-*.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload IPK/APK to Telegram
        if: success() && github.event_name == 'workflow_dispatch' && inputs.upload_telegram == 'true'
        env:
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
          VERSION: ${{ needs.get_version.outputs.version }}
        run: |
          shopt -s globstar
          for file in dist/**/${{ env.PKG_NAME }}_*.ipk dist/**/${{ env.PKG_NAME }}-*.apk; do
            [ -f "$file" ] || continue
            FILENAME=$(basename "$file")
            curl -s -X POST "https://api.telegram.org/bot${TG_BOT_TOKEN}/sendDocument" \
              -F chat_id="${TG_CHAT_ID}" \
              -F document=@"$file" \
              -F caption="ðŸš€ OpenClash v${VERSION} | ðŸ“¦ ${FILENAME}"
          done
          
