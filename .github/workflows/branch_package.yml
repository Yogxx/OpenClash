name: Branch Package

on:
  workflow_dispatch:
    inputs:
      upload_release:
        description: Upload ke GitHub Release
        required: true
        default: "false"
        type: choice
        options: ["false", "true"]

      upload_telegram:
        description: Upload ke Telegram
        required: true
        default: "true"
        type: choice
        options: ["false", "true"]

env:
  PKG_NAME: luci-app-openclash
  PACKAGE_BRANCH: package
  PACKAGE_DIR: master

jobs:
  get_version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.ver.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: package

      - id: ver
        run: |
          if [ -f version ]; then
            echo "version=$(cat version)" >> $GITHUB_OUTPUT
          else
            echo "version=unknown" >> $GITHUB_OUTPUT
          fi

  release:
    runs-on: ubuntu-latest
    needs: get_version

    steps:
      - name: Checkout package branch
        uses: actions/checkout@v4
        with:
          ref: package
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare package files
        run: |
          set -e
          VERSION="${{ needs.get_version.outputs.version }}"
          mkdir -p "${PACKAGE_DIR}"

          # bersihkan versi lama
          rm -f ${PACKAGE_DIR}/${PKG_NAME}_*.ipk
          rm -f ${PACKAGE_DIR}/${PKG_NAME}_*.apk

          # copy dari artifact (INI YANG BENAR)
          find artifacts -name "*.ipk" -exec cp {} ${PACKAGE_DIR}/${PKG_NAME}_${VERSION}_all.ipk \;
          find artifacts -name "*.apk" -exec cp {} ${PACKAGE_DIR}/${PKG_NAME}_${VERSION}.apk \;

          echo "$VERSION" > ${PACKAGE_DIR}/version

      - name: Commit & push to package branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions@users.noreply.github.com"

          git add ${PACKAGE_DIR}
          git commit -m "update ${PKG_NAME} ${VERSION}" || echo "no changes"
          git push origin ${PACKAGE_BRANCH}

      - name: Upload to Telegram
        if: inputs.upload_telegram == 'true'
        env:
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
          VERSION: ${{ needs.get_version.outputs.version }}
        run: |
          for f in ${PACKAGE_DIR}/*.ipk ${PACKAGE_DIR}/*.apk; do
            [ -f "$f" ] || continue
            curl -s -X POST "https://api.telegram.org/bot${TG_BOT_TOKEN}/sendDocument" \
              -F chat_id="${TG_CHAT_ID}" \
              -F document=@"$f" \
              -F caption="ðŸ“¦ OpenClash ${VERSION}\n$(basename "$f")"
          done
          
