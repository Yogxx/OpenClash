name: Branch Package

on:
  workflow_dispatch:
    inputs:
      upload_release:
        description: 'Upload ke GitHub Release?'
        required: true
        default: 'true'
        type: choice
        options: [ 'false', 'true' ]

      upload_telegram:
        description: 'Upload IPK/APK ke Telegram?'
        required: true
        default: 'false'
        type: choice
        options: [ 'false', 'true' ]

env:
  PKG_NAME: luci-app-openclash
  TARGET: x86/64

jobs:
  get_version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.ver.outputs.version }}
    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          ref: master

      - id: ver
        run: |
          VER=$(grep '^PKG_VERSION:=' luci-app-openclash/Makefile | cut -d= -f2)
          echo "version=$VER" >> "$GITHUB_OUTPUT"

  build:
    runs-on: ubuntu-latest
    needs: get_version
    strategy:
      fail-fast: false
      matrix:
        type: [ ipk, apk ]

    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          ref: master

      - name: Install deps
        run: |
          sudo apt update
          sudo apt install -y curl git tar zstd unzip jq \
            python3 python3-pyelftools python3-setuptools

      - name: Download SDK
        run: |
          mkdir -p sdk && cd sdk
          if [ "${{ matrix.type }}" = "ipk" ]; then
            curl -Lf https://downloads.openwrt.org/releases/22.03.0/targets/x86/64/openwrt-sdk-22.03.0-x86-64_gcc-11.2.0_musl.Linux-x86_64.tar.xz | tar xJ
          else
            curl -Lf https://downloads.openwrt.org/snapshots/targets/x86/64/openwrt-sdk-x86-64_gcc-14.3.0_musl.Linux-x86_64.tar.zst | tar --zstd -xf -
          fi
          mv openwrt-sdk-* openwrt

      - name: Copy source
        run: cp -r luci-app-openclash sdk/openwrt/package/

      - name: Compile po2lmo
        run: |
          cd sdk/openwrt/package/luci-app-openclash/tools/po2lmo
          make && sudo make install

      - name: Compile package
        run: |
          cd sdk/openwrt
          make defconfig
          make package/${{ env.PKG_NAME }}/compile -j$(nproc)

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: openclash-${{ matrix.type }}
          path: sdk/openwrt/bin/packages/**/${{ env.PKG_NAME }}*

  release:
    runs-on: ubuntu-latest
    needs: [ get_version, build ]

    steps:
      - uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Create GitHub Release
        if: inputs.upload_release == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.get_version.outputs.version }}
          name: OpenClash v${{ needs.get_version.outputs.version }}
          files: dist/**/${{ env.PKG_NAME }}*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Push packages to package branch
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          git clone https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }} repo
          cd repo
          git checkout package

          mkdir -p package/master
          cp -f ../dist/**/${{ env.PKG_NAME }}* package/master/ || true

          cd package/master
          ls -t luci-app-openclash_* 2>/dev/null | tail -n +11 | xargs -r rm --

          cd ../..
          git add package/master
          git commit -m "update OpenClash packages v${{ needs.get_version.outputs.version }}" || echo "No changes"
          git push origin package
          
