name: Branch Package

on:
  push:
    branches: [ master ]
    paths:
      - 'luci-app-openclash/Makefile'

  workflow_dispatch:
    inputs:
      upload_release:
        description: 'Upload ke GitHub Release?'
        required: true
        default: 'false'
        type: choice
        options: [ 'false', 'true' ]

      upload_telegram:
        description: 'Upload ke Telegram?'
        required: true
        default: 'true'
        type: choice
        options: [ 'false', 'true' ]

env:
  PKG_NAME: luci-app-openclash
  TARGET: x86/64

jobs:
  get_version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.ver.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: master

      - id: ver
        run: |
          VER=$(grep '^PKG_VERSION:=' luci-app-openclash/Makefile | cut -d= -f2)
          echo "version=$VER" >> "$GITHUB_OUTPUT"

  build:
    runs-on: ubuntu-latest
    needs: get_version
    strategy:
      fail-fast: false
      matrix:
        type: [ ipk, apk ]

    steps:
      - uses: actions/checkout@v4
        with:
          ref: master

      - name: Install deps
        run: |
          sudo apt update
          sudo apt install -y curl git tar zstd unzip jq \
            python3 python3-pyelftools python3-setuptools

      - name: Download OpenWrt SDK
        run: |
          mkdir -p sdk && cd sdk
          if [ "${{ matrix.type }}" = "ipk" ]; then
            curl -Lf https://downloads.openwrt.org/releases/22.03.0/targets/x86/64/openwrt-sdk-22.03.0-x86-64_gcc-11.2.0_musl.Linux-x86_64.tar.xz | tar xJ
          else
            curl -Lf https://downloads.openwrt.org/snapshots/targets/x86/64/openwrt-sdk-x86-64_gcc-14.3.0_musl.Linux-x86_64.tar.zst | tar --zstd -xf -
          fi
          mv openwrt-sdk-* openwrt

      - name: Copy source
        run: |
          cp -r luci-app-openclash sdk/openwrt/package/

      - name: Compile po2lmo
        run: |
          cd sdk/openwrt/package/luci-app-openclash/tools/po2lmo
          make && sudo make install

      - name: Compile package
        run: |
          cd sdk/openwrt
          make defconfig
          make package/${{ env.PKG_NAME }}/compile -j$(nproc)

      - name: Verify build output
        run: |
          find sdk/openwrt/bin/packages -name "${{ env.PKG_NAME }}*" -type f
          if ! find sdk/openwrt/bin/packages -name "${{ env.PKG_NAME }}*" -type f | grep -q .; then
            echo "âŒ build output not found"
            exit 1
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PKG_NAME }}-${{ matrix.type }}
          path: sdk/openwrt/bin/packages/**/${{ env.PKG_NAME }}*

  release:
    runs-on: ubuntu-latest
    needs: [ get_version, build ]

    steps:
      - uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Push to package branch
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          git clone https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }} repo
          cd repo
          git checkout package

          mkdir -p package/master

          cp -v ../dist/**/${{ env.PKG_NAME }}_*.ipk package/master/ || true
          cp -v ../dist/**/${{ env.PKG_NAME }}_*.apk package/master/ || true

          cd package/master

          # hapus versi lama (keep 10)
          ls -t ${{ env.PKG_NAME }}_*.ipk 2>/dev/null | tail -n +11 | xargs -r rm --
          ls -t ${{ env.PKG_NAME }}_*.apk 2>/dev/null | tail -n +11 | xargs -r rm --

          cd ../..
          git add package/master
          git commit -m "update OpenClash v${{ needs.get_version.outputs.version }}" || echo "no changes"
          git push origin package

      - name: GitHub Release
        if: github.event.inputs.upload_release == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.get_version.outputs.version }}
          name: OpenClash v${{ needs.get_version.outputs.version }}
          files: |
            dist/**/${{ env.PKG_NAME }}_*.ipk
            dist/**/${{ env.PKG_NAME }}_*.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload to Telegram
        if: github.event.inputs.upload_telegram == 'true'
        env:
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
          VERSION: ${{ needs.get_version.outputs.version }}
        run: |
          shopt -s globstar nullglob
          for file in dist/**/${{ env.PKG_NAME }}_*.ipk dist/**/${{ env.PKG_NAME }}_*.apk; do
            curl -s -X POST "https://api.telegram.org/bot${TG_BOT_TOKEN}/sendDocument" \
              -F chat_id="${TG_CHAT_ID}" \
              -F document=@"$file" \
              -F caption="ðŸš€ OpenClash v${VERSION} | ðŸ“¦ $(basename "$file")"
          done
          
