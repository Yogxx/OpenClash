name: Build & Publish OpenClash Package

on:
  workflow_dispatch:
    inputs:
      upload_release:
        description: "Upload to GitHub Release"
        required: true
        default: "false"
      upload_telegram:
        description: "Upload to Telegram"
        required: true
        default: "true"

env:
  PACKAGE_BRANCH: package
  PACKAGE_DIR: master

jobs:
  get_version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      - id: version
        run: |
          VERSION=$(cat version | tr -d '\n')
          echo "version=$VERSION" >> $GITHUB_OUTPUT

  build:
    runs-on: ubuntu-latest
    needs: get_version
    strategy:
      matrix:
        type: [ipk, apk]

    steps:
      - uses: actions/checkout@v4

      - name: Build ${{ matrix.type }}
        run: |
          mkdir -p output
          if [ "${{ matrix.type }}" = "ipk" ]; then
            cp luci-app-openclash_*.ipk output/luci-app-openclash_${{ needs.get_version.outputs.version }}_all.ipk
          else
            cp luci-app-openclash_*.apk output/luci-app-openclash_${{ needs.get_version.outputs.version }}.apk
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: luci-app-openclash-${{ matrix.type }}
          path: output/*

  release:
    runs-on: ubuntu-latest
    needs: [get_version, build]

    steps:
      - name: Checkout package branch
        uses: actions/checkout@v4
        with:
          ref: package
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Update package files
        run: |
          mkdir -p master

          # hapus versi lama
          rm -f master/luci-app-openclash_*.ipk
          rm -f master/luci-app-openclash_*.apk

          # copy file baru
          cp artifacts/**/* master/

          # update version file
          echo "${{ needs.get_version.outputs.version }}" > master/version

      - name: Commit & push
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add master
          git commit -m "update luci-app-openclash ${{ needs.get_version.outputs.version }}" || exit 0
          git push

      - name: Upload to Telegram
        if: ${{ github.event.inputs.upload_telegram == 'true' }}
        run: |
          for f in master/luci-app-openclash_*; do
            curl -F document=@"$f" \
              "https://api.telegram.org/bot${{ secrets.TG_BOT_TOKEN }}/sendDocument?chat_id=${{ secrets.TG_CHAT_ID }}"
          done

      - name: Create GitHub Release
        if: ${{ github.event.inputs.upload_release == 'true' }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.get_version.outputs.version }}
          files: master/luci-app-openclash_*
          
